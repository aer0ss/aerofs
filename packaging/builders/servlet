#!/bin/bash -ue

if [[ $# -ne 3 || "$1x" == "x" || "$2x" == "x" || "$3x" == "x" ]]
then
    echo "usage: $0 [servlet_name] [base_dir] [proj_dir]"
    echo
    echo "example: $0 sv ~/repos/aerofs aerofs.spsv"
    exit 2
fi

SERVLET_NAME="$1"
BASEDIR="$2"
PROJDIR="$3"

PACKAGE_NAME="$SERVLET_NAME"
BUILDROOT="$PACKAGE_NAME"

RESOURCES="$BASEDIR"/src/"$PROJDIR"/resources/"$SERVLET_NAME"
INSTALL="$BUILDROOT"/usr/share/aerofs-"$PACKAGE_NAME"/"$SERVLET_NAME"
CONTEXT="$BUILDROOT"/etc/tomcat6/Catalina/localhost
DEBIAN="$BUILDROOT"/DEBIAN

rm -rf "$BUILDROOT"

mkdir -p "$BUILDROOT"
mkdir -p "$INSTALL"
mkdir -p "$CONTEXT"
mkdir -p "$DEBIAN"

# debian files
for F in control
do
    cp -R "$RESOURCES"/$F "$DEBIAN"
done

# Logging directory for aerofs tomcat applications.
cat << EOF >> "$DEBIAN"/preinst
#!/bin/bash
mkdir -p /var/log/aerofs
EOF

# Must be done after install to ensure existance of the tomcat package.
cat << EOF >> "$DEBIAN"/postinst
#!/bin/bash
chown -R tomcat6:tomcat6 /var/log/aerofs
EOF

chmod 0755 "$DEBIAN"/postinst
chmod 0755 "$DEBIAN"/preinst

# package-data files
cp -R "$BASEDIR"/out.ant/artifacts/"$SERVLET_NAME"/exploded/* "$INSTALL"/

# ensure logging.properties exists for convenient tomcat debugging.
cat << EOF >> "$INSTALL"/WEB-INF/classes/logging.properties
org.apache.catalina.core.ContainerBase.[Catalina].level = DEBUG
org.apache.catalina.core.ContainerBase.[Catalina].handlers = java.util.logging.ConsoleHandler
EOF

CONTEXT_FILENAME="ROOT.xml"
# Since we can't deploy sv to root (due to alpha and staging systems), we deploy
# it at sv_beta
if [ $SERVLET_NAME == "sv" ]
then
    CONTEXT_FILENAME="sv_beta.xml"
fi

cp -R "$RESOURCES"/context.xml "$CONTEXT"/"$CONTEXT_FILENAME"

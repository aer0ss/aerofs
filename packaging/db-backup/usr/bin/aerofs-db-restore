#!/bin/bash
set -eu

function usage()
{
    echo "Usage: $0 <aerofs_db_backup_file>"
}

function malformed_db_backup()
{
    echo "ERROR: Malformed db backup file: $@."
}

if [ $# -ne 1 ]
then
    usage
    exit 1
fi

file="$1"

if [ ! -f "$file" ]
then
    echo "ERROR: \"$file\" does not exist."
    usage
    exit 2
fi

echo ">>> Reading backup file..."

tempdir=$(mktemp -d /tmp/aerofs-db-backup.XXXXXXXXX)
cp -a "$file" "$tempdir"

pushd $tempdir 1>/dev/null 2>/dev/null
tar xf $file

if [ ! -d aerofs-db-backup ]
then
    malformed_db_backup "expected top level directory \"aerofs-db-backup\""
    exit 3
fi

if [ ! -f aerofs-db-backup/redis.aof ]
then
    malformed_db_backup "expected file \"aerofs-db-backup/redis.aof\" not found"
    exit 4
fi

if [ ! -f aerofs-db-backup/mysql.dump ]
then
    malformed_db_backup "expected file \"aerofs-db-backup/mysql.dump\" not found"
    exit 5
fi

if [ ! -d aerofs-db-backup/ca-files ]
then
    malformed_db_backup "expected dir \"aerofs-db-backup/ca-files\" not found"
    exit 6
fi

if [ ! -f aerofs-db-backup/external.properties ]
then
    malformed_db_backup "expected dir \"aerofs-db-backup/external.properties\" not found"
    exit 7
fi

echo ">>> Restoring redis database..."
service redis-aof stop 1>/dev/null 2>/dev/null
rm -f /data/redis/redis.*
cp -a aerofs-db-backup/redis.aof /data/redis
service redis-aof start 1>/dev/null 2>/dev/null

echo ">>> Restoring mysql database..."
mysql < aerofs-db-backup/mysql.dump

echo ">>> Restoring CA files..."
service ca-server stop 1>/dev/null 2>/dev/null || true
rm -rf /opt/ca/prod
mkdir -p /opt/ca/prod
cp -a aerofs-db-backup/ca-files/* /opt/ca/prod
service ca-server start 1>/dev/null 2>/dev/null

echo ">>> Restoring configuration properties..."
cp -a aerofs-db-backup/external.properties /opt/config/properties

popd 1>/dev/null 2>/dev/null

echo ">>> AeroFS databases successfully restored."

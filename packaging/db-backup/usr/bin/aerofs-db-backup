#!/bin/bash
set -eu

tempdir=$(mktemp -d /tmp/aerofs-db-backup.XXXXXXXXX)
rm -rf $tempdir
mkdir -p $tempdir/aerofs-db-backup
pushd $tempdir 1>/dev/null 2>/dev/null

echo ">>> Backing up redis database..."
if [ ! -f /data/redis/redis.aof ]
then
    touch /data/redis/redis.aof
fi
cp -a /data/redis/redis.aof aerofs-db-backup/redis.aof

echo ">>> Backing up mysql database..."
mysqldump --events --all-databases > aerofs-db-backup/mysql.dump

echo ">>> Backing up CA files..."
cp -a /opt/ca/prod aerofs-db-backup/ca-files

echo ">>> Backing up configuration properites..."
cp -a /opt/config/properties/external.properties aerofs-db-backup/external.properties

echo ">>> Backing up verkehr persistent topics..."
mkdir -p aerofs-db-backup/topics
rsync --sparse -a /data/topics/. aerofs-db-backup/topics/.

echo ">>> Creating backup file..."
# gnu tar does not handle reading sparse files efficiently using SEEK_HOLE
# bsd tar does not handle extracting sparse files efficiently and fills all the holes
# takeaway: create tars with bsdtar, and extract them with gnutar
bsdtar -Scf aerofs-db-backup.tar aerofs-db-backup/*
gzip aerofs-db-backup.tar

popd 1>/dev/null 2>/dev/null
cp -a $tempdir/aerofs-db-backup.tar.gz .
rm -rf $tempdir

echo ">>> AeroFS appliance data backed up to $(pwd)/aerofs-db-backup.tar.gz"

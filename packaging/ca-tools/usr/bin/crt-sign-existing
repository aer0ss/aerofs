#!/bin/bash

CA_HOST="joan.aerofs.com"

if [ $# -ne 3 ] && [ $# -ne 4 ]
then
	echo "Usage: `basename $0` <existing_crt_file> <existing_key_file> <output_directory> [<ca_host>=$CA_HOST]"
	exit 1
fi

EXISTING_CRT_FILE=$1
EXISTING_KEY_FILE=$2
OUTPUT_DIRECTORY=$3

if [ $# -eq 4 ]
then
    CA_HOST="$2"
fi

CA_URL="http://$CA_HOST:1029/prod"

echo ">>> Generating certificate via $CA_URL"
echo ">>> Creating dir for server keys and certs"

SERVER_SSL_DIR="$OUTPUT_DIRECTORY""_ssl"

rm -rf $SERVER_SSL_DIR
mkdir $SERVER_SSL_DIR
cp "$EXISTING_CRT_FILE" "$SERVER_SSL_DIR"/old.crt
cp "$EXISTING_KEY_FILE" "$SERVER_SSL_DIR"/"$OUTPUT_DIRECTORY".key
cd $SERVER_SSL_DIR

echo ">>> Generating CSR from existing cert and key"

openssl x509 \
    -x509toreq \
    -in old.crt \
    -out "$OUTPUT_DIRECTORY"".csr" \
    -signkey "$OUTPUT_DIRECTORY".key

echo ">>> Submitting request to CA"

curl --silent -X POST \
    --data-binary @"$OUTPUT_DIRECTORY"".csr" \
    --output "$OUTPUT_DIRECTORY"".crt" \
    "$CA_URL""?""$RANDOM-$OUTPUT_DIRECTORY"

CERTIFICATE_STRING='-----BEGIN CERTIFICATE-----'

if [ -f "$OUTPUT_DIRECTORY".crt ] && \
    grep -xq -- "$CERTIFICATE_STRING" "$OUTPUT_DIRECTORY".crt
then
	echo ">>> Certificate created successfully!"
else
	echo ">>> Certificate NOT created!"
    exit 2
fi

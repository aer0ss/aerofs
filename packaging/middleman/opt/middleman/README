Middleman
=========

What is it?
-----------

Middleman is a man in the middle https server. We use it to reroute calls to aws in order to install whatever package we want to via the automatic updater.

How do I use it?
----------------

1) Install the aerofs-middleman package.

2) Edit /opt/middleman/middleman.conf and set the target to the url you will be forwarding to

3) Copy /opt/middleman/cacert.pem to all clients

4) On each client run (you may have to modify the command to use the correct path to lib/security/cacerts):
    Linux:
        sudo keytool -keystore /usr/lib/jvm/java-6-openjdk/jre/lib/security/cacerts -importcert -alias maninthemiddle -file cacert.pem

    Windows:
        C:\Program Files (x86)\Java\jre7\bin\keytool -keystore C:\Program Files (x86)\Java\jre7\lib\security\cacerts -importcert -alias maninthemiddle -file cacert.pem

    Mac OS X:
        sudo keytool -keystore /System/Library/Frameworks/JavaVM.framework/Home/lib/security/cacerts -importcert -alias maninthemiddle -file cacert.pem

5) Execute: service middleman restart

6) Edit necessary hosts files / dnsmasq config on middleman so that requests to s3 get directed to the box running middleman.
    - In /etc/dnsmasq.conf:
        address=/nocache.client.aerofs.com/<IP of middleman>
        address=/cache.client.aerofs.com/<IP of middleman>

    - In /etc/hosts: (This may be redundant. OS X requires the above form but other OS's are fine with only the settings below)
        <IP of middleman> nocache.client.aerofs.com
        <IP of middleman> cache.client.aerofs.com

7) Execute: service dnsmasq restart

8) Set clients' nameserver addresses to the IP address of middleman (can be /etc/resolv.conf for POSIX systems or done through the GUI).

9) Laugh in the face of the poor clients who are being lied to.

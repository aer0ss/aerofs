{% extends "logged_in.html" %}

{% block title %}Billing | AeroFS Private Cloud{% endblock %}

{% block head %}
<style type="text/css" media="screen">
    .has-error input {
      border-width: 2px;
    }
    .validation.text-danger:after {
      content: 'Validation failed';
    }
    .validation.text-success:after {
      content: 'Validation passed';
    }

.card{
  position:absolute;
  display:block;
  right:1em;
  top:15%;
  margin-top:-10px;
  width:28px;
  height:19px;
  background:url(
    {% if card.brand == "Visa" %}
      {{ url_for('static', filename='img/visa.png')}}
    {% elif card.brand == "American Express" %}
      {{ url_for('static', filename='img/amex.png')}}
    {% elif card.brand == "MasterCard "%}
      {{ url_for('static', filename='img/mastercard.png')}}
    {% elif card.brand == "Discover" %}
      {{ url_for('static', filename='img/discover.png')}}
    {% elif card.brand == "JCB" %}
      {{ url_for('static', filename='img/jcb.png')}}
    {% elif card.brand == "Diners Club" %}
      {{ url_for('static', filename='img/diners.png')}}
    {% else %}
      {{ url_for('static', filename='img/card.svg')}}
    {% endif %}
    ) no-repeat center center;
  background-size: 100%;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
  <h1>Credit card information</h1>
  <div class="col-sm-5">
    <div class="row">
      <form novalidate id="ccInfo" autocomplete="on" method="POST">
        <input name=_csrf_token type=hidden value="{{ csrf_token() }}">

        <div class="form-group">
          <label for="cc-number" class="control-label">Credit Card Number:</label>
          <input id="cc-number" type="tel" class="input-lg form-control cc-number" autocomplete="cc-number" placeholder="•••• •••• •••• {% if card %}{{ card.last4 }}{% else %}••••{% endif %}" required>
          <span class="card" aria-hidden="true"></span>
        </div>

        <div class="form-group">
          <label for="cc-exp" class="control-label">Expiry Date:</label>
          <input id="cc-exp" type="tel" class="input-lg form-control cc-exp" autocomplete="cc-exp" placeholder="{% if card %}{{card.exp_month }} / {{ card.exp_year }}{% else %} YY / MM{% endif %}" required>
        </div>

        <div class="form-group">
          <label for="cc-cvc" class="control-label">CVC:</label>
          <input id="cc-cvc" type="tel" class="input-lg form-control cc-cvc" autocomplete="off" placeholder="•••" required>
        </div>

        <button id="submit" type="submit" class="btn btn-lg btn-primary">Update Credit Card</button>
      </form>
    </div>
  </div>
</div>

<form id='form' method="POST" role="form" style="form-inline">
 <input name=_csrf_token type=hidden value="{{ csrf_token() }}">
</form>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/jquery.payment.js') }}" ></script>
<script type="text/javascript" src="https://js.stripe.com/v2/"></script>
<script>
Stripe.setPublishableKey('{{ stripe_pk }}');

jQuery(function($) {
  $('.cc-number').payment('formatCardNumber');
  $('.cc-exp').payment('formatCardExpiry');
  $('.cc-cvc').payment('formatCardCVC');

  $.fn.toggleInputError = function(erred) {
    this.parent('.form-group').toggleClass('has-error', erred);
    return this;
  };

  $('#cc-number').keypress(function(e) {
    var cardType = $.payment.cardType($('.cc-number').val());
    if (cardType == "visa") {
      $('.card').css("background-image", "url( {{ url_for('static', filename='img/visa.png') }} )" );
    } else if (cardType == "amex") {
      $('.card').css("background-image", "url( {{ url_for('static', filename='img/amex.png') }} )" );
    } else if (cardType == "mastercard") {
      $('.card').css("background-image", "url( {{ url_for('static', filename='img/mastercard.png') }} )" );
    } else if(cardType == "discover") {
      $('.card').css("background-image", "url( {{ url_for('static', filename='img/discover.png') }} )" );
    } else if (cardType == "maestro") {
      $('.card').css("background-image", "url( {{ url_for('static', filename='img/maestro.png') }} )" );
    } else if (cardType == "dinersclub") {
      $('.card').css("background-image", "url( {{ url_for('static', filename='img/diners.png') }} )" );
    } else if (cardType == "jcb") {
      $('.card').css("background-image", "url( {{ url_for('static', filename='img/jcb.png') }} )" );
    } else {
      $('.card').css("background-image", "url( {{ url_for('static', filename='img/card.svg') }} )" );
    }
  });

  function stripeResponseHandler(status, response) {
    var $form = $('#ccInfo');
    if (response.error) {
        // Show the errors on the form
        showErrorMessageUnsafe(response.error.message);
        $form.find('button').prop('disabled', false);
    } else {

       var $input = $('<input type=hidden name=stripeToken />').val(response.id);
       $('#form').append($input).submit();
    }
  }

  $('#ccInfo').submit(function(e) {
    e.preventDefault();
    var $form = $(this);
    $form.find('button').prop('disabled', true);

    var cardType = $.payment.cardType($('.cc-number').val());
    $('.cc-number').toggleInputError(!$.payment.validateCardNumber($('.cc-number').val()));
    $('.cc-exp').toggleInputError(!$.payment.validateCardExpiry($('.cc-exp').payment('cardExpiryVal')));
    $('.cc-cvc').toggleInputError(!$.payment.validateCardCVC($('.cc-cvc').val(), cardType));

    var expgroup = $("#cc-exp").val();
    var expArr = expgroup.split( '/' );
    var expmm = parseInt( expArr[0] );
    var expyy = parseInt( expArr[1] );

    var valid = $.payment.validateCardNumber($('.cc-number').val()) &&
      $.payment.validateCardExpiry($('.cc-exp').payment('cardExpiryVal')) &&
      $.payment.validateCardCVC($('.cc-cvc').val(), cardType);

    if (valid) {
      Stripe.createToken({
        number: $(".cc-number").val(),
        cvc: $(".cc-cvc").val(),
        exp_month: expmm,
        exp_year: expyy
      }, stripeResponseHandler);
    }
  });
});
</script>
{% endblock %}

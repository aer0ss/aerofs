#!/bin/bash

# This script creates the approot directory and populates it
# with the files needed for a staging AeroFS

set -e

if [ x"$1" == x ]; then
    echo "usage: $0 <approot> <resource> <mode=STAGING> <multiplicity=CLIENT> <os>" >&2
    echo "    <approot>  The approot folder path which doesn't need to pre-exist." >&2
    echo "    <resource> The resource/client folder path which must exist." >&2
    echo "    <mode>     (optional) specifies which cacert.pem file to use and whether or not" >&2
    echo "               APPROOT/stg should be created. Can be STAGING or CI. Defaults to STAGING." >&2
    echo "    <multiplicity> (optional) whether or not to populate as a Team Server." >&2
    echo "               Can be TEAM_SERVER or CLIENT. Defaults to CLIENT." >&2
    echo "    <os>       (optional) The OS to populate for. Can be osx, win, linux32 or" >&2
    echo "               linux64. If not set, we will use the output from the ./os script." >&2
    exit 1
fi

PPWD="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

APPROOT="$1"
ASIS="$2"
MODE="${3:-'STAGING'}"
MULTIPLICITY="${4:-'CLIENT'}"
OS="${5:-`"$PPWD"/os`}"

VERSION_FILE=version

# Copy files to approot
mkdir -p "$APPROOT"
rm -rf "$APPROOT"/Growl.framework # Symlinks prevent cp from overwriting the files
cp -R "$ASIS"/common/* "$APPROOT"/
cp -R "$ASIS"/s3/lib/* "$APPROOT"/lib/
cp -R "$ASIS"/$OS/* "$APPROOT"/

if [ "$MODE" == "CI" ]; then
    # Set-up a CI environment
    rm "$APPROOT"/cacert-staging.pem
    mv "$APPROOT"/cacert-ci.pem "$APPROOT"/cacert.pem
else
    # Set-up a staging environment
    touch "$APPROOT"/stg
    rm "$APPROOT"/cacert-ci.pem
    mv "$APPROOT"/cacert-staging.pem "$APPROOT"/cacert.pem
fi

if [ "$MULTIPLICITY" == "TEAM_SERVER" ]; then
    touch "$APPROOT"/ts
fi

# Common to both staging and CI
echo "100.0.0" > "$APPROOT"/$VERSION_FILE
rm "$APPROOT"/cacert-prod.pem

# Add the run script.
cp "$PPWD/os" "$PPWD/run" "$APPROOT"/


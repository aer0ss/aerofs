#!/bin/bash
set -e -u
#
# Upload the OVA artifact and tag the commit used.
#

include common

[ $# -ne 1 ] && {
    echo "usage: $0 [version]" >&2
    exit $ERRBADARGS
}
RELEASE_VERSION=${1:-}
check_version_format $RELEASE_VERSION

upload_artifacts() {
    local FILE="$(dirname "$0")/../../out.ship/appliance/preloaded/aerofs-appliance-${RELEASE_VERSION}.ova"
    test -r "${FILE}" || {
        echo "${FILE} does not exist." >&2
        exit $ERRBADARGS
    }
    s3cmd --acl-public --guess-mime-type put "${FILE}" s3://aerofs.privatecloud
}

tag_release() {
    echo ">> tagging git release"
    local TAG="docker-${RELEASE_VERSION}"
    git tag -a ${TAG} -m ${TAG}
    git push --tags
}

notify_successful_build() {
    echo ">> notifying team of successful deployment via Slack"

    for room in "#eng" "#success"
    do
        echo "Build notification: PC $RELEASE_VERSION pushed to S3 (by $(whoami)). This version is not yet available to the public." |
            $(git rev-parse --show-cdup)puppetmaster/modules/slack/files/slack_message \
                -r "$room" \
                -c good \
                -u $SLACK_WEBHOOK \
                -f "Build" > /dev/null
    done
}

upload_artifacts
tag_release
notify_successful_build

echo ">> Tagged and bagged!"
echo ">> Go to http://privatecloud.aerofs.com:8000/ to mark this as the current release."

#!/bin/bash -e -u

###############################################################################
#
# General includes
#
###############################################################################
include include/common ${1:-} ${2:-}

###############################################################################
#
# usage and parameters
#
###############################################################################
if [[ $# -lt 1 || $# -gt 3 ]]; then
    echo "usage: $0 [build mode] [passphrase]" >&2
    echo " " >&2
    echo "[build mode]: PROD|STAGING|ENTERPRISE" >&2
    echo "[build product]: CLIENT|TEAM_SERVER" >&2
    echo "[passphrase]: release passphrase" >&2
    echo " " >&2
    echo "example: $0 STAGING CLIENT" >&2
    echo "example: $0 PROD TEAM_SERVER [passphrase]" >&2
    exit $ERRBADARGS
fi

# PROD requires a passphrase to deploy
if [[ x"${3:-}" == x && $MODE == "PROD" ]]; then
    echo "error: passphrase required for production release" >&2
    exit $ERRBADPASS
fi

readonly PASSPHRASE="${3:-$UNSECURED_PASSPHRASE}"

#******************************************************************************
#******************************************************************************
#**
#** Run all of the build steps
#**
#******************************************************************************
#******************************************************************************
if is_prod ; then
    echo
    echo "!!!!!!!!!!!!!!!!!!!!!!!"
    echo "!! DEPLOY PRODUCTION !!"
    echo "!!!!!!!!!!!!!!!!!!!!!!!"
    echo
fi

compute_next_release_version
echo '+---------------------------------'
echo '| ' $RELEASE_VERSION $PRODUCT $MODE
echo '+---------------------------------'

call make_release_resources $MODE $PRODUCT $RELEASE_VERSION
call make_client_installers $MODE $PRODUCT $RELEASE_VERSION "$PASSPHRASE"
echo ">> successfully built $MODE $PRODUCT release version $RELEASE_VERSION"
exit 0

#!/bin/bash
set -eu
set -x

###############################################################################
#
# This script moves platform specific libraries to the proper locations,
# creates an obfuscated jar for AeroFS and prepares the code for packaging.
# Everything here is done on the local system.
#
###############################################################################

include include/common ${1:-} ${2:-}

###############################################################################
#
# arguments and usage
#
###############################################################################
function DieUsage() {
    set +x
    echo "usage: $0 [build mode] [build product] [release version] [--no-obfuscate]" >&2
    echo " " >&2
    echo "[build mode]: PUBLIC|PRIVATE" >&2
    echo "[build product]: CLIENT|TEAM_SERVER" >&2
    echo "[release version]: major.minor.build" >&2
    echo "--no-obfuscate: optional (default is to obfuscate)" >&2
    echo " " >&2
    echo "example: $0 PUBLIC TEAM_SERVER 0.4.99" >&2
    exit $ERRBADARGS
}

[[ $# -eq 3 || $# -eq 4 ]] || DieUsage
readonly RELEASE_VERSION="$3"

if [ $# -eq 4 ] && [ "$4" != "--no-obfuscate" ]; then DieUsage; fi

######################################################################
#
# Copies and creates the necessary resources in a local resource folder
# for each platform. This includes moving platform specific libraries,
# copying the correct certificates, and creating a version file.
#
######################################################################
function copy_resources_to_local_release_directories() {
    echo ">> copying resources to release directory"

    #------------------------------------------------------
    # setup the directory structure
    #------------------------------------------------------

    # Remove the old release directory
    rm -rf "${LOCAL_RELEASE_DIR}"

    # Create the required destination directories
    mkdir -p "${AEROFS_RELEASE_DIR}/"
    mkdir -p "${AEROFS_RELEASE_DIR}/lib"
    mkdir -p "${AEROFS_RELEASE_WIN_DIR}/"
    mkdir -p "${AEROFS_RELEASE_OSX_DIR}/"
    mkdir -p "${AEROFS_RELEASE_LINUX_DIR}/"
    mkdir -p "${AEROFS_RELEASE_LINUX_SHARED_DIR}/lib/"

    local local_BIN="${LOCAL_RELEASE_DIR}/bin"
    local local_ALL_PLATFORMS_RELEASE_LIB="${AEROFS_RELEASE_DIR}/lib"

    #------------------------------------------------------
    # copy over the classfiles
    #------------------------------------------------------

    mkdir -p "${local_BIN}"

    # the /* is necessary with GNU cp to copy the contents of bin, rather than
    # bin itself
    cp -R "${BUILD_OUTPUT_DIR}/bin"/* "${local_BIN}"

    # remove unnecessary files
    # TODO (WW) make sure files to be removed are at correct locations. See the
    # labeling process code for an example.
    find "${local_BIN}/" -name .DS_Store  | xargs rm -f
    find "${local_BIN}/" -name .gitignore | xargs rm -f

    if is_public_or_private ; then
        # TODO: (AG) move these as excludes into build.xml
        # TODO: (WW) Verify this package is valid before removing
        rm -rf "${local_BIN}/com/aerofs/tools"
    fi

    #------------------------------------------------------
    # copy platform-specific and platform-independent resources/libraries
    #------------------------------------------------------

    # common, platform-independent jars _only_ (resources are copied below)
    local local_COMMON_RESOURCES_DIR_JARDIRS=$( ls -d "${COMMON_RESOURCES_DIR}"/lib* | xargs -n1 basename )
    local_COMMON_RESOURCES_DIR_JARDIRS=${local_COMMON_RESOURCES_DIR_JARDIRS/lib.test/} # exclude the lib.test dir
    for local_JARDIR in $local_COMMON_RESOURCES_DIR_JARDIRS
    do
        cp -R "${COMMON_RESOURCES_DIR}/${local_JARDIR}"/* "${local_ALL_PLATFORMS_RELEASE_LIB}"
    done

    # client, platform-independent resources (includes jars as well as other resources)
    local local_CLIENT_RESOURCES_DIR_CONTENTS=$( ls -d "$CLIENT_ALL_PLATFORMS_RESOURCES_DIR"/* | xargs -n1 basename )
    local_CLIENT_RESOURCES_DIR_CONTENTS=${local_CLIENT_RESOURCES_DIR_CONTENTS/lib.s3/} # exclude the lib.s3 dir
    for local_CONTENT in $local_CLIENT_RESOURCES_DIR_CONTENTS
    do
        if [[ $local_CONTENT == lib* ]]; then
            cp -R "${CLIENT_ALL_PLATFORMS_RESOURCES_DIR}/${local_CONTENT}"/* "${local_ALL_PLATFORMS_RELEASE_LIB}"
        else
            cp -R "${CLIENT_ALL_PLATFORMS_RESOURCES_DIR}/${local_CONTENT}" "${AEROFS_RELEASE_DIR}"
        fi
    done

    # copy S3 jars if necessary
    cp -R "${CLIENT_ALL_PLATFORMS_RESOURCES_DIR}/lib.s3"/* "${AEROFS_RELEASE_LINUX_SHARED_DIR}/lib/" # linux (always)
    if is_team_server ; then
        cp -R "${CLIENT_ALL_PLATFORMS_RESOURCES_DIR}/lib.s3"/ "${AEROFS_RELEASE_OSX_DIR}/lib/" # osx (only for ts)
        cp -R "${CLIENT_ALL_PLATFORMS_RESOURCES_DIR}/lib.s3"/ "${AEROFS_RELEASE_WIN_DIR}/lib/" # win (only for ts)
    fi

    # platform-specific resources and jars native libs
    cp -R "${CLIENT_OSX_RESOURCES_DIR}"/* "${AEROFS_RELEASE_OSX_DIR}/"
    cp -R "${CLIENT_WIN_RESOURCES_DIR}"/* "${AEROFS_RELEASE_WIN_DIR}/"
    cp -R "${CLIENT_LINUX_RESOURCES_DIR}"/* "${AEROFS_RELEASE_LINUX_DIR}/"

    # copy shell extension if product=client
    if is_client ; then
        cp -R "${CLIENT_OSX_SHELLEXT_DIR}"/* "${AEROFS_RELEASE_OSX_DIR}/"
        cp -R "${CLIENT_WIN_SHELLEXT_DIR}"/* "${AEROFS_RELEASE_WIN_DIR}/"
    fi

    # Create the symlinks to launcher that will later be copied into the
    # approot.  The symlinks the user should use directly will be created later
    # as part of the debian package and tgz.
    # pushd is used to ensure symlinks made are relative
    pushd ${AEROFS_RELEASE_LINUX_SHARED_DIR} > /dev/null
        ln -s launcher "${AEROFS_PRODUCT_UNIX}"
        # Create symlinks for each of the products
        for SUFFIX in cli gui sh ; do
            ln -s "${AEROFS_PRODUCT_UNIX}" "${AEROFS_PRODUCT_UNIX}-$SUFFIX"
        done
    popd > /dev/null

    #------------------------------------------------------
    # copy the properties files (*.properties, *.xml, etc.)
    #------------------------------------------------------

    cp "${LABELING_FILE}" "${local_BIN}/"

    for mode_resource in "${MODE_RESOURCES_DIR}/${LOWERCASE_MODE}"/* ; do
        cp "$mode_resource" "${local_BIN}"/
    done

    cp -R "${OTHER_RESOURCES_DIR}"/* "${local_BIN}/"

    #------------------------------------------------------
    # special handling for the pem file
    #------------------------------------------------------

    mv "${local_BIN}/cacert.pem" "${AEROFS_RELEASE_DIR}/"

    #------------------------------------------------------
    # update the installer files with render_template
    #------------------------------------------------------

    # Render templated fields for OSX and Linux updater scripts.
    render_template "${CLIENT_OSX_TEMPLATES_DIR}/updater.sh" "${AEROFS_RELEASE_OSX_DIR}/updater.sh"
    render_template "${CLIENT_LINUX_SHARED_TEMPLATES_DIR}/updater.sh" "${AEROFS_RELEASE_LINUX_SHARED_DIR}/updater.sh"

    # Render templated fields for Linux launcher, INSTALL instructions,
    # update-package launcher, and freedesktop.org desktop file.
    render_template "${CLIENT_LINUX_TEMPLATES_DIR}/INSTALL" "${AEROFS_RELEASE_LINUX_DIR}/INSTALL"
    render_template "${CLIENT_LINUX_SHARED_TEMPLATES_DIR}/copier" "${AEROFS_RELEASE_LINUX_SHARED_DIR}/copier"
    render_template "${CLIENT_LINUX_SHARED_TEMPLATES_DIR}/launcher" "${AEROFS_RELEASE_LINUX_SHARED_DIR}/launcher"
    render_template "${CLIENT_LINUX_SHARED_TEMPLATES_DIR}/product.desktop" "${AEROFS_RELEASE_LINUX_SHARED_DIR}/${AEROFS_PRODUCT_UNIX}.desktop"
}


######################################################################
#
# Creates the Java manifest file and creates the AeroFS jar
#
######################################################################
function create_java_jar() {
    echo ">> creating jar"

    # Make a temporary file which will be the manifest
    local local_TEMP_MANIFEST="$(mktemp -t manifest_XXXXXX.tmp)"
    trap "rm -f $local_TEMP_MANIFEST || true" EXIT

    echo "Main-Class: com.aerofs.Main" > "$local_TEMP_MANIFEST"
    echo "Class-Path: " >> "$local_TEMP_MANIFEST"

    for i in "$AEROFS_RELEASE_DIR"/lib/*.jar; do
        echo " lib/$(basename "$i") " >> "$local_TEMP_MANIFEST"
    done

    #echo N.B. platform-dependent jars must have identical names
    for i in "$AEROFS_RELEASE_WIN_DIR"/lib/*; do
        echo " lib/$(basename "$i") " >> "$local_TEMP_MANIFEST"
    done

    # s3 jars
    for i in "$CLIENT_RESOURCES_DIR"/s3/lib/*.jar; do
        echo " lib/$(basename "$i") " >> "$local_TEMP_MANIFEST"
    done

    # *.properties, *.xml files
    local local_JAR_PROPERTY_FLAGS=""
    for i in ${LOCAL_RELEASE_DIR}/bin/* ; do
        if [ -f $i ]; then
            local_JAR_PROPERTY_FLAGS="$local_JAR_PROPERTY_FLAGS -C ${LOCAL_RELEASE_DIR}/bin ${i##*/}"
            echo " $( basename $i ) " >> "$local_TEMP_MANIFEST"
        fi
    done

    # Package a jar with the contents of com subdirectory of the local release directory (all the class files)
    jar cfm "${AEROFS_RELEASE_DIR}/aerofs.unobf.jar" "$local_TEMP_MANIFEST" -C "${LOCAL_RELEASE_DIR}/bin" com $local_JAR_PROPERTY_FLAGS
}

######################################################################
#
# Runs ProGuard on the unobfuscated aerofs jar
#
# We now use the same class files for both regular client and team server,
# so the proguard maps should be indistinguishable.
#
######################################################################
function obfuscate_java() {
    echo ">> obfuscating jar"

    local local_PG_AEROFS_DIR=`echo $AEROFS_RELEASE_DIR | sed -e 's|/cygdrive/\([a-zA-Z]\)/|\1:/|'`
    local local_PG_RELEASE_DIR=`echo $LOCAL_RELEASE_DIR | sed -e 's|/cygdrive/\([a-zA-Z]\)/|\1:/|'`
    local local_PG_HOME=`echo $PROGUARD_HOME | sed -e 's|/cygdrive/\([a-zA-Z]\)/|\1:/|'`

    # TODO: (WW) Verify these packages are valid before removing
    "${PROGUARD_HOME}/bin/proguard.sh" -injars "${local_PG_AEROFS_DIR}/aerofs.unobf.jar" -outjars "${local_PG_AEROFS_DIR}/aerofs.jar" \
        -printmapping "${local_PG_RELEASE_DIR}/aerofs.map" \
        -repackageclasses "com.aerofs" \
        -dontwarn 'com.aerofs.tools.**' \
        -dontnote 'com.aerofs.l.*' \
        @"${local_PG_HOME}/aerofs.pro" \
        @"${local_PG_HOME}/aerofs-$(uname).pro"

    rm -rf "${local_PG_AEROFS_DIR}/aerofs.unobf.jar"
}

function skip_obfuscate_java() {
    echo ">> skipping obfuscation of jar"
    local local_PG_AEROFS_DIR=`echo $AEROFS_RELEASE_DIR | sed -e 's|/cygdrive/\([a-zA-Z]\)/|\1:/|'`
    mv "${local_PG_AEROFS_DIR}/aerofs.unobf.jar" "${local_PG_AEROFS_DIR}/aerofs.jar"
}

######################################################################
#
# Writes the release version and checksums of the binaries to the version file.
#
######################################################################
function write_version_and_checksums() {
    echo ">> writing version and checksums"

    local local_VERSION_FILE="${AEROFS_RELEASE_DIR}/version"

    # Create a version file in the AeroFS release directory
    echo $RELEASE_VERSION > "$local_VERSION_FILE"

    local local_CHKSUM_LIST="\
        aerofs.jar:${AEROFS_RELEASE_DIR}/aerofs.jar \
        aerofsd.dll:${AEROFS_RELEASE_WIN_DIR}/aerofsd.dll \
        aerofsj.dll:${AEROFS_RELEASE_WIN_DIR}/aerofsj.dll \
        libaerofsd.dylib:${AEROFS_RELEASE_OSX_DIR}/libaerofsd.dylib \
        libaerofsj.dylib:${AEROFS_RELEASE_OSX_DIR}/libaerofsj.dylib \
    "

    for i in $local_CHKSUM_LIST; do
        local local_FILE_PATH="$(echo $i | sed -e 's/.*://')"
        local local_FILE_NAME="$(echo $i | sed -e 's/:.*//')"
        local local_CHKSUM="$(shasum -a 256 $local_FILE_PATH | sed -e 's/ .*//')"
        echo "$local_FILE_NAME=$local_CHKSUM" >> "$local_VERSION_FILE"
    done
}

#*******************************************************
#*******************************************************
#**
#** Run the actual steps to create the release resources
#**
#*******************************************************
#*******************************************************
echo ">> make release resources"

compute_product_names
copy_resources_to_local_release_directories
create_java_jar
if [ "${4:-}" == "--no-obfuscate" ]; then
    skip_obfuscate_java
else
    obfuscate_java
fi
write_version_and_checksums

exit 0

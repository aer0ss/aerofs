#!/bin/bash
set -e -u
include include/common "PUBLIC"

if [[ $# -ne 1 ]]; then
    echo "usage: $0 [version to release]" >&2
    echo "example: $0 0.8.34" >&2
fi

# Check version number
VERSION_TO_PROMOTE="$1"

check_version_format "$VERSION_TO_PROMOTE"

lock_release_server "promoting $VERSION_TO_PROMOTE to public release"
kssh $RELEASE_SERVER_LOGIN $RELEASE_SERVER_SHELL <<EOF
    if [[ ! -d $INSTALLERS_DOWNLOAD_DIR/$VERSION_TO_PROMOTE ]] ; then
        echo "Proposed deployment folder $INSTALLERS_DOWNLOAD_DIR/$VERSION_TO_PROMOTE does not appear to exist on $RELEASE_SERVER"
        exit $ERRBADARGS
    fi
    echo "Version=$VERSION_TO_PROMOTE" > $INSTALLERS_DOWNLOAD_DIR/release-versions/current.ver
EOF
publish_public_to_s3 $INSTALLER_DOWNLOAD_BUCKET
unlock_release_server

echo ">> successfully deployed $VERSION_TO_PROMOTE as current.ver to the public"

#!/bin/sh

set -e -u

#################################
# arguments

if [ $# -gt 2 ]; then
    echo "usage: $0 [staging|prod] [passphrase]"
    echo "[build mode]: staging, prod"
    echo "[passphrase]: passphrase for pushing"
    echo
    echo "example: $0"
    echo "example: $0 staging"
    echo "example: $0 prod [passphrase]"
    exit 2
fi

#################################
# build mode

MODE=${1:-} # if $1 doesn't exist, then "" is substituted
if [ "$MODE" == "prod" ]; then
    MODE=prod
    echo
    echo "!!!!!!!!!!!!!!!!!!!!!!!"
    echo "!! DEPLOY PRODUCTION !!"
    echo "!!!!!!!!!!!!!!!!!!!!!!!"
    echo
else
    MODE=staging
fi

#################################
# set parameters

STAGING_PASSPHRASE=temp123

# passphrase
PASSPHRASE=${2:-} # if $2 doesn't exist, then "" is substituted
if [ x"$PASSPHRASE" == x ]; then
    if [ $MODE == "prod" ]; then
        echo "cannot use staging passphrase to push to prod"
        exit 3
    else
        PASSPHRASE="$STAGING_PASSPHRASE"
    fi
fi

# directories
# see: http://stackoverflow.com/questions/59895/can-a-bash-script-tell-what-directory-its-stored-in
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )" # get the directory this script is in no matter where it's called from
AEROFS_GIT_ROOT="$( cd $SCRIPT_DIR/../..; pwd )" # get the absolute path
BUILD_DIR=$AEROFS_GIT_ROOT/out.ant
RELEASE_DIR=$BUILD_DIR/release

#################################
# jar the aerofs code; create windows and linux installers and zip files

./package $MODE "$AEROFS_GIT_ROOT" "$BUILD_DIR" "$RELEASE_DIR"
./publish $MODE "$AEROFS_GIT_ROOT" "$RELEASE_DIR" "$PASSPHRASE"

#################################
# create mac installer and zipfile

cd osx/
./package $MODE "$AEROFS_GIT_ROOT" "$RELEASE_DIR"
./publish $MODE

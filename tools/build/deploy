#!/bin/sh

set -e -u

#################################
# arguments

if [ $# -lt 1 ] || [ $# -gt 2 ]; then
    echo "usage: $0 [build_mode] [passphrase]"
    echo "[build mode]: STAGING or PROD"
    echo "[passphrase]: passphrase for pushing"
    echo
    echo "example: $0 STAGING"
    echo "example: $0 PROD [passphrase]"
    exit 2
fi

#################################
# build mode

MODE=""
if [ "$1" == "PROD" ]; then
    MODE="PROD"
    echo
    echo "!!!!!!!!!!!!!!!!!!!!!!!"
    echo "!! DEPLOY PRODUCTION !!"
    echo "!!!!!!!!!!!!!!!!!!!!!!!"
    echo
elif [ "$1" == "STAGING" ]; then
    MODE="STAGING"
else
    echo "Invalid build mode $1.  Expected STAGING or PROD."
    exit 2
fi

#################################
# set parameters

STAGING_PASSPHRASE=temp123

# passphrase
PASSPHRASE=${2:-} # if $2 doesn't exist, then "" is substituted
if [ x"$PASSPHRASE" == x ]; then
    if [ $MODE == "PROD" ]; then
        echo "cannot use staging passphrase to push to prod"
        exit 3
    else
        PASSPHRASE="$STAGING_PASSPHRASE"
    fi
fi

# directories
# see: http://stackoverflow.com/questions/59895/can-a-bash-script-tell-what-directory-its-stored-in
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )" # get the directory this script is in no matter where it's called from
AEROFS_GIT_ROOT="$( cd $SCRIPT_DIR/../..; pwd )" # get the absolute path
BUILD_DIR=$AEROFS_GIT_ROOT/out.ant
RELEASE_DIR=$BUILD_DIR/release

#################################
# jar the aerofs code; create windows and linux installers and zip files

./package $MODE "$AEROFS_GIT_ROOT" "$BUILD_DIR" "$RELEASE_DIR"
./publish $MODE "$AEROFS_GIT_ROOT" "$RELEASE_DIR" "$PASSPHRASE"

#################################
# create mac installer and zipfile

cd osx/
./package $MODE "$AEROFS_GIT_ROOT" "$RELEASE_DIR"
./publish $MODE

#!/bin/bash -e -u

###############################################################################
#
# General includes
#
###############################################################################
include include/common ${1:-}

###############################################################################
#
# usage and parameters
#
###############################################################################
if [[ $# -ne 1 ]]; then
    echo "usage: $0 [build mode]" >&2
    echo " " >&2
    echo "[build mode]: STAGING or PROD" >&2
    echo " " >&2
    echo "example: $0 STAGING" >&2
    exit $ERRBADARGS
fi

###############################################################################
#
# Emails team@aerofs.com about this deployment.
#
###############################################################################
function notify_successful_deployment() {
    echo ">> notifying team of successful deployment"
    kssh $RELEASE_SERVER_LOGIN $RELEASE_SERVER_SHELL << ENDCMDS
        echo ' ' | mail -s "[$MODE] $RELEASE_VERSION deployed by $USER" team@aerofs.com
ENDCMDS
}

###############################################################################
#
# Tags this release with an annotated tag so it is easy to checkout a deployed
# build for debugging.
#
###############################################################################
function tag_release() {
    if is_prod ; then
        echo ">> tagging git release"
        git tag -a "$RELEASE_VERSION" -m "$RELEASE_VERSION"
        git push --tags
    fi
}

#******************************************************************************
#******************************************************************************
#**
#** Run all of the deployment steps
#**
#******************************************************************************
#******************************************************************************
if is_prod ; then
    echo
    echo "!!!!!!!!!!!!!!!!!!!!!!!"
    echo "!! DEPLOY PRODUCTION !!"
    echo "!!!!!!!!!!!!!!!!!!!!!!!"
    echo
fi

compute_next_release_version
echo '+--------------------------'
echo '| ' $RELEASE_VERSION $MODE
echo '+--------------------------'

call exec_prepublish_checks $MODE $RELEASE_VERSION
publish_to_s3 $RELEASE_VERSION $INSTALLER_DOWNLOAD_BUCKET
tag_release
notify_successful_deployment

echo ">> successfully deployed $MODE release version $RELEASE_VERSION"
exit 0

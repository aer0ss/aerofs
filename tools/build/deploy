#!/bin/bash
set -e -u

###############################################################################
#
# General includes
#
###############################################################################
include include/common ${1:-}

###############################################################################
#
# usage and parameters
#
###############################################################################
if [[ $# -ne 1 ]]; then
    echo "usage: $0 [build mode]" >&2
    echo " " >&2
    echo "[build mode]: PUBLIC|PRIVATE" >&2
    echo " " >&2
    echo "example: $0 PUBLIC" >&2
    exit $ERRBADARGS
fi

# The version file should have been produced by the packaging scripts.
VERSION_FILE="$PACKAGE_DIR/$CURRENT_VER"
if [[ ! -r "$VERSION_FILE" ]]; then
    echo "Expected to find a version file at $VERSION_FILE but I couldn't read the version number"
    exit $ERRBADVERSION
fi
RELEASE_VERSION=$(cat "$VERSION_FILE" | cut -d = -f 2)
# Check that the version string has the right format.
if [[ ! $RELEASE_VERSION =~ $RELEASE_VERSION_REGEX ]]; then
    echo "Expected version string matching <major>.<minor>.<build>, got '$RELEASE_VERSION'"
    exit $ERRBADVERSION
fi

function upload_packages_to_release_server() {
    # Upload the immutable artifacts (versioned installers) first, so
    # incrementing the version moves atomically between consistent states
    echo ">>> rsyncing packages to $RELEASE_SERVER:$INSTALLERS_DOWNLOAD_DIR/$RELEASE_VERSION/"
    rsync --archive --verbose "$PACKAGE_DIR"/* $RELEASE_SERVER_LOGIN:$INSTALLERS_DOWNLOAD_DIR/$RELEASE_VERSION/
    echo ">>> rsyncing version to $RELEASE_SERVER:$INSTALLERS_DOWNLOAD_DIR/release-versions/$CANARY_VER"
    rsync --archive --verbose "$PACKAGE_DIR"/$CURRENT_VER $RELEASE_SERVER_LOGIN:$INSTALLERS_DOWNLOAD_DIR/release-versions/$CANARY_VER
}

function upload_packages_to_antivirus_firms() {
    # Upload latest version of script
    kscp $BUILD_SCRIPT_DIR/send_package_to_antivirus_firms.sh $RELEASE_SERVER_LOGIN:
    # Spawn script in background - script will delete self on completion.
    kssh $RELEASE_SERVER_LOGIN $RELEASE_SERVER_SHELL << ENDCMDS
        chmod a+x \$HOME/send_package_to_antivirus_firms.sh
        screen -d -m \$HOME/send_package_to_antivirus_firms.sh $INSTALLERS_DOWNLOAD_DIR/$RELEASE_VERSION/AeroFSInstall-$RELEASE_VERSION.exe
ENDCMDS
}

# main: Run all of the deployment steps
if is_private ; then
    echo "Hey, deploy doesn't do anything for Private mode. See approve_appliance."
    exit 0
fi

echo
echo "!!!!!!!!!!!!!!!!!!!!!!!"
echo "!! DEPLOY PRODUCTION !!"
echo "!!!!!!!!!!!!!!!!!!!!!!!"
echo
echo '+--------------------------'
echo '| ' $RELEASE_VERSION $MODE
echo '+--------------------------'

upload_map
call exec_prepublish_checks $MODE $RELEASE_VERSION
lock_release_server "deploying $MODE $RELEASE_VERSION"
upload_packages_to_release_server
upload_packages_to_antivirus_firms
publish_public_to_s3 $INSTALLER_DOWNLOAD_BUCKET
unlock_release_server
tag_release public
notify_successful_deployment

echo ">> successfully deployed $MODE release version $RELEASE_VERSION"
exit 0

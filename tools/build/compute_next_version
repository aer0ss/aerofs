#!/bin/bash
set -e -u
#
# Compute, and then print, the next release version to use.
#

# TAGS are in the format of:
# {
#  "latest": "21ed100dc4415868097fe2319c006665e2c9d5f28bae1e76c0808cf82ae3f3b5",
#  "1.0.9": "8ed0e1102c26aadb56352805256f411638b7b646a21a33df279a630863b14bc7",
#  "1.0.12": "21ed100dc4415868097fe2319c006665e2c9d5f28bae1e76c0808cf82ae3f3b5",
#  ...
# }

TAGS="$(curl -sS https://registry.aerofs.com/v1/repositories/aerofs/loader/tags | jq .)"
[[ -n "${TAGS}" ]] || {
    echo "ERROR: couldn't get loader tag list"
    exit 11
}

LATEST_ID=$(echo "${TAGS}" | jq -r .latest)
CUR_VER_LINE="$(echo "${TAGS}" | grep "${LATEST_ID}" | grep -v latest)"
CUR_VER=$(echo "{${CUR_VER_LINE}}" | tr ',' ' ' | jq -r keys[])
[[ -n "${CUR_VER}" ]] || {
    echo "ERROR: couldn't get current version. Please check aerofs/loader tags at registry.aerofs.com:"
    echo "${TAGS}"
    exit 22
}

CUR_MAJOR_MINOR="$( echo ${CUR_VER} | sed -e 's/\.[0-9]*$//' )"
CUR_BUILD="$( echo ${CUR_VER} | sed -e 's/.*\.//' )"
NEXT_MAJOR_MINOR="$(cat "$(dirname "${BASH_SOURCE[0]}")"/version)"

if [ ${CUR_MAJOR_MINOR} == ${NEXT_MAJOR_MINOR} ]; then
    NEXT_BUILD=$((CUR_BUILD + 1))
else
    NEXT_BUILD=1
fi

echo ${NEXT_MAJOR_MINOR}.${NEXT_BUILD}

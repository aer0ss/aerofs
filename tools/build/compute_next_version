#!/bin/bash
set -e -u

# Compute, and then print, the next release version to use.
# If UNSIGNED is requested, a snapshot id will be generated:
#   0.<date>.<time>
#
# If SIGNED is requested, the max value is found from S3, the
# build number is incremented, and the result is used.
#

include include/common PRIVATE

CUR_VER="$( current_release_version )"
[[ $CUR_VER != "" ]] || exit $ERRBADVERSION
CUR_VER_MAJOR_MINOR="$( echo $CUR_VER | sed -e 's/\.[0-9]*$//' )"
CUR_VER_BUILD="$( echo $CUR_VER | sed -e 's/.*\.//' )"
NEXT_VER_MAJOR_MINOR="$( head -1 ${BUILD_SCRIPT_DIR}/version )"

readonly CUR_VER
readonly CUR_VER_MAJOR_MINOR
readonly CUR_VER_BUILD
readonly NEXT_VER_MAJOR_MINOR

BUILD_NUMBER=""
if [ $CUR_VER_MAJOR_MINOR == $NEXT_VER_MAJOR_MINOR ]; then  #FIXME (AG): verify they've actually bumped the number
    BUILD_NUMBER="$( expr $CUR_VER_BUILD \+ 1 )"
else
    BUILD_NUMBER=1 # reset build number to 1
fi

# Print the result so ant can use it:
echo "$NEXT_VER_MAJOR_MINOR.$BUILD_NUMBER"

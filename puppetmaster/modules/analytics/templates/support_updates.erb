#!/bin/bash
#Copyright Air Computing, Inc. 2012
#
# This script updates the mysql email analytics table
# With the previous week's reported user bugs.
########################################################

MYSQL_USER="<%= mysql_user %>"
MYSQL_PASSWD="<%= mysql_passwd %>"
MYSQL_HOST="<%= mysql_host %>"
MYSQL_TABLE="analytics"

echo "Please enter the YEAR and WEEK of the cohort in the format 'yyyyww' (e.g. 201240):"
read YEARWEEK

echo "Please enter the number of incoming tickets for $YEARWEEK:"
read TOTAL_IN

echo "Please enter the number of resolved tickets for $YEARWEEK:"
read TOTAL_RES

echo "Please enter the number of userbugs added to YouTrack for $YEARWEEK:"
read YT_USER

echo "Please enter the number of userbugs marked major (or higher) for $YEARWEEK:"
read YT_USER_MAJOR

echo "Please enter the number of userbugs resolved in $YEARWEEK:"
read YT_USER_SOLVED

echo "Thanks!"


#########################################
# The MYSQL_USER is a tightly priviliged user that can only execute select and insert commands on the
# analytics.trailing_cohort_analytics_for_email table.

mysql -u$MYSQL_USER -p$MYSQL_PASSWD -h$MYSQL_HOST $MYSQL_TABLE -e \
    "INSERT INTO trailing_cohort_analytics_for_email (cohort, support_in,support_resolved, support_userbugs_yt, support_userbugs_yt_major, support_userbugs_yt_resolved) \
    VALUES('$YEARWEEK','$TOTAL_IN','$TOTAL_RES','$YT_USER','$YT_USER_MAJOR','$UT_USER_SOLVED') \
    ON DUPLICATE KEY UPDATE \
    support_in='$TOTAL_IN', \
    support_resolved='$TOTAL_RES', \
    support_userbugs_yt='$YT_USER', \
    support_userbugs_yt_major='$YT_USER_MAJOR', \
    support_userbugs_yt_resolved='$YT_USER_SOLVED';"
